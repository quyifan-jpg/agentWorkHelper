# AIWorkHelper 后端项目启动指南

## 项目结构

```
AIWorkHelper/
├── etc/                    # 配置文件目录
│   └── api.yaml           # API 服务配置文件
├── internal/              # 内部私有代码
│   ├── config/            # 配置结构定义
│   ├── handler/           # 请求处理层
│   │   ├── api/           # HTTP API 处理器
│   │   │   ├── user.go    # 用户相关接口
│   │   │   ├── todo.go    # 待办事项接口
│   │   │   ├── approval.go # 审批接口
│   │   │   ├── chat.go    # AI 聊天接口
│   │   │   └── ...
│   │   └── ws/            # WebSocket 处理器
│   │       ├── ws.go      # WebSocket 服务器
│   │       └── conversation.go # 会话处理
│   ├── logic/             # 业务逻辑层
│   │   ├── chatinternal/  # AI 聊天内部逻辑
│   │   │   ├── todohandler.go    # 待办处理器
│   │   │   ├── approvalhandle.go # 审批处理器
│   │   │   └── toolx/            # AI 工具集
│   │   ├── user.go        # 用户业务逻辑
│   │   ├── todo.go        # 待办业务逻辑
│   │   └── approval.go    # 审批业务逻辑
│   ├── model/             # 数据模型层（MongoDB）
│   ├── domain/            # 领域对象/DTO
│   ├── middleware/        # 中间件（JWT、日志等）
│   └── svc/               # 服务上下文（依赖注入）
├── pkg/                   # 公共可复用包
│   ├── langchain/         # LangChain 扩展
│   │   ├── router/        # 智能路由系统
│   │   └── memoryx/       # 多会话内存管理
│   ├── token/             # JWT Token 工具
│   ├── httpx/             # HTTP 工具
│   ├── curl/              # HTTP 请求封装
│   └── ...
├── mds/                   # 项目文档
├── upload/                # 文件上传目录
├── main.go                # 程序入口
├── go.mod                 # Go 模块依赖
├── go.sum                 # 依赖校验文件
├── Makefile               # 构建脚本
└── CLAUDE.md              # AI 开发指南
```

## 技术栈

- **语言**: Go 1.24.6
- **Web 框架**: Gin (HTTP) + Gorilla WebSocket
- **数据库**: MongoDB 数据存储
- **缓存**: Redis
- **AI/LLM**: LangChain Go + 阿里云 DashScope
- **身份认证**: JWT Token
- **日志**: 分布式链路追踪 (tlog)
- **配置管理**: Viper

## 前置要求

在开始之前，请确保您的电脑上已安装以下软件：

### 1. Go 语言环境（必需）

- **版本要求**: Go 1.24.6 或更高版本
- **下载地址**: https://golang.org/dl/
- **验证安装**:
  ```bash
  go version
  # 应该显示: go version go1.24.6 或更高版本
  ```

### 2. MongoDB 数据库（必需）

- **版本要求**: MongoDB 4.4 或更高版本
- **下载地址**: https://www.mongodb.com/try/download/community
- **验证安装**:
  ```bash
  # 检查 MongoDB 服务是否运行
  # macOS/Linux
  mongosh --version

  # Windows
  mongo --version
  ```

### 3. Redis（必需）

- **版本要求**: Redis 6.x 或更高版本
- **下载地址**: https://redis.io/download
- **验证安装**:
  ```bash
  redis-cli --version
  ```


### 1. 下载 Go 模块依赖

```bash
# 进入项目根目录
cd AIWorkHelper

# 下载所有依赖包
go mod download

# 或者使用 tidy 命令（推荐）
go mod tidy
```

**等待时间**: 首次下载可能需要 3-10 分钟，取决于网络速度

**常见问题**:

- 如果下载速度很慢，可以配置 Go 模块代理:
  ```bash
  # 使用国内七牛云代理
  go env -w GOPROXY=https://goproxy.cn,direct

  # 或使用阿里云代理
  go env -w GOPROXY=https://mirrors.aliyun.com/goproxy/,direct
  ```

### 2. 验证依赖安装

```bash
# 检查是否有缺失的依赖
go mod verify
```

---

## 环境配置

### 1. 检查配置文件

项目根目录下的 `etc/` 文件夹包含配置文件：
- `etc/api.yaml` - API 服务配置

### 2. 配置说明

打开 `etc/api.yaml` 文件，确认以下配置：

```yaml
# 应用程序基本配置
Name: aiworkhelper
Addr: 0.0.0.0:8888          # API 服务监听端口
Host: "http://127.0.0.1:8888"

# WebSocket 配置
Ws:
  Addr: 0.0.0.0:9000        # WebSocket 服务监听端口

# MongoDB 数据库配置
Mongo:
  User: ""                   # 用户名（本地开发可为空）
  Password: ""               # 密码（本地开发可为空）
  Hosts: ["127.0.0.1"]       # MongoDB 主机地址
  Port: 27017                # MongoDB 端口
  Database: "aiworkhelper"   # 数据库名称

# JWT Token 配置
Jwt:
  Secret: "kuangbiao.camps"  # JWT 密钥（生产环境请修改）
  Expire: 8640000            # Token 过期时间（秒）

# LangChain AI 配置
Langchain:
  Url: "https://dashscope.aliyuncs.com/compatible-mode/v1"
  ApiKey: "your-api-key-here"  # 请替换为您的阿里云 DashScope API Key

# 文件上传配置
Upload:
  SavePath: "upload/"
  Host: "http://127.0.0.1:8000"

# Redis 配置
Redis:
  Addr: "0.0.0.0:6379"
```

**重要提示**:

1. **LangChain API Key**: 必须配置有效的阿里云 DashScope API Key，否则 AI 功能无法使用
   - 获取地址: https://dashscope.console.aliyun.com/

2. **MongoDB**: 确保 MongoDB 服务已启动并且可以连接

3. **Redis**: 确保 Redis 服务已启动

### 3. 数据库准备

**MongoDB 数据库会自动创建**，无需手动创建。首次启动时，应用会自动：
- 创建数据库 `aiworkhelper`
- 创建必要的集合（collections）

---

## 启动项目

**先确保安装的mongodb和redis容器先启动**

### 开发模式启动

#### 方式一: 直接运行，推荐用于开发调试

```bash
# 在项目根目录执行
go run main.go

# 或指定配置文件
go run main.go -f ./etc/api.yaml -m api
```

#### 方式二: 编译后运行

```bash
# 编译项目
go build -o aiworkhelper .

# 运行编译后的程序
./aiworkhelper

# Windows 用户
aiworkhelper.exe
```

**成功提示**:

```
Langchain URL: https://dashscope.aliyuncs.com/compatible-mode/v1
Langchain ApiKey: sk-xxxxx...

[GIN-debug] Listening and serving HTTP on 0.0.0.0:8888
[WS] WebSocket server started on 0.0.0.0:9000
```

### 验证服务运行

#### 1. 检查 HTTP API 服务

打开浏览器或使用 curl 访问：

```bash
# 健康检查（如果有的话）
curl http://localhost:8888/ping

# 或测试登录接口
curl -X POST http://localhost:8888/v1/user/login \
  -H "Content-Type: application/json" \
  -d '{"name":"root","password":"123456"}'
```







