# WebSocket å®ç°è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

BackEnd é¡¹ç›®å·²å®ç° WebSocket åŠŸèƒ½ï¼Œç”¨äºå®æ—¶èŠå¤©ï¼ˆç§èŠå’Œç¾¤èŠï¼‰ã€‚å®ç°å‚è€ƒäº† AIWorkHelper é¡¹ç›®çš„æ¶æ„ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æœåŠ¡ç»“æ„

```
BackEnd/
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â””â”€â”€ ws/
â”‚   â”‚       â””â”€â”€ ws.go          # WebSocket æœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.go          # é…ç½®ç»“æ„ï¼ˆåŒ…å« WS é…ç½®ï¼‰
â”‚   â””â”€â”€ ...
â”œâ”€â”€ cmd/api/
â”‚   â””â”€â”€ main.go               # ä¸»ç¨‹åºï¼ˆåŒæ—¶å¯åŠ¨ HTTP å’Œ WebSocketï¼‰
â””â”€â”€ etc/
    â””â”€â”€ backend.yaml          # é…ç½®æ–‡ä»¶ï¼ˆåŒ…å« WS é…ç½®ï¼‰
```

### 2. æ ¸å¿ƒç»„ä»¶

#### WebSocket æœåŠ¡å™¨ (`internal/handler/ws/ws.go`)

- **è¿æ¥ç®¡ç†**ï¼šä½¿ç”¨ `uidToConn` å’Œ `connToUid` åŒå‘æ˜ å°„ç®¡ç†ç”¨æˆ·è¿æ¥
- **æ¶ˆæ¯å¤„ç†**ï¼šæ”¯æŒç§èŠï¼ˆchatType=2ï¼‰å’Œç¾¤èŠï¼ˆchatType=1ï¼‰
- **èº«ä»½éªŒè¯**ï¼šé€šè¿‡ JWT Token éªŒè¯ç”¨æˆ·èº«ä»½
- **å¹¶å‘å®‰å…¨**ï¼šä½¿ç”¨ `sync.RWMutex` ä¿æŠ¤è¿æ¥æ˜ å°„

#### é…ç½® (`internal/config/config.go`)

```go
WS struct {
    Host string `mapstructure:"Host"` // WebSocket æœåŠ¡åœ°å€
    Port int    `mapstructure:"Port"` // WebSocket æœåŠ¡ç«¯å£
}
```

#### é…ç½®æ–‡ä»¶ (`etc/backend.yaml`)

```yaml
WS:
  Host: "127.0.0.1"
  Port: 9000
```

## ğŸ”Œ è¿æ¥æ–¹å¼

### å‰ç«¯è¿æ¥

å‰ç«¯é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿æ¥ WebSocketï¼š

```typescript
// æ–¹å¼1ï¼šé€šè¿‡ URL å‚æ•°ä¼ é€’ tokenï¼ˆæµè§ˆå™¨ WebSocket API é™åˆ¶ï¼‰
const wsUrl = `ws://127.0.0.1:9000/ws?token=${token}`

// æ–¹å¼2ï¼šé€šè¿‡è¯·æ±‚å¤´ä¼ é€’ tokenï¼ˆå¦‚æœæ”¯æŒï¼‰
// Header: websocket: <token>
```

### åç«¯è®¤è¯

åç«¯æ”¯æŒä¸¤ç§æ–¹å¼è·å– Tokenï¼š

1. **è¯·æ±‚å¤´**ï¼š`websocket: <token>`
2. **URL å‚æ•°**ï¼š`?token=<token>`

## ğŸ“¨ æ¶ˆæ¯æ ¼å¼

### å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯

```json
{
  "conversationId": "",      // ä¼šè¯IDï¼ˆç§èŠä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œç¾¤èŠä¸ºç¾¤IDï¼‰
  "recvId": "123",           // æ¥æ”¶è€…IDï¼ˆç§èŠå¿…å¡«ï¼Œç¾¤èŠä¸ºç©ºï¼‰
  "sendId": "",              // å‘é€è€…IDï¼ˆç”±æœåŠ¡å™¨ä»Tokenä¸­æå–ï¼Œæ— éœ€å‰ç«¯ä¼ é€’ï¼‰
  "chatType": 2,             // èŠå¤©ç±»å‹ï¼š1=ç¾¤èŠï¼Œ2=ç§èŠ
  "content": "ä½ å¥½",         // æ¶ˆæ¯å†…å®¹
  "contentType": 1           // å†…å®¹ç±»å‹ï¼š1=æ–‡æœ¬ï¼Œ2=å›¾ç‰‡ç­‰
}
```

### æœåŠ¡å™¨è¿”å›æ¶ˆæ¯

```json
{
  "conversationId": "abc123", // ä¼šè¯IDï¼ˆç§èŠä¸ºç”Ÿæˆçš„å”¯ä¸€IDï¼Œç¾¤èŠä¸ºç¾¤IDï¼‰
  "recvId": "123",           // æ¥æ”¶è€…ID
  "sendId": "456",           // å‘é€è€…ID
  "chatType": 2,             // èŠå¤©ç±»å‹
  "content": "ä½ å¥½",         // æ¶ˆæ¯å†…å®¹
  "contentType": 1           // å†…å®¹ç±»å‹
}
```

## ğŸ”„ æ¶ˆæ¯æµç¨‹

### ç§èŠæµç¨‹

1. **å®¢æˆ·ç«¯å‘é€**ï¼šç”¨æˆ·Aé€šè¿‡ WebSocket å‘é€ç§èŠæ¶ˆæ¯ç»™ç”¨æˆ·B
2. **æœåŠ¡å™¨å¤„ç†**ï¼š
   - éªŒè¯ Tokenï¼Œè·å–å‘é€è€…ID
   - è°ƒç”¨ `PrivateChat` ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
   - ç”Ÿæˆä¼šè¯IDï¼ˆå¦‚æœæœªæä¾›ï¼‰
   - æŸ¥æ‰¾ç”¨æˆ·Bçš„ WebSocket è¿æ¥
   - å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·B
3. **æ¥æ”¶è€…æ¥æ”¶**ï¼šç”¨æˆ·Bçš„ WebSocket è¿æ¥æ”¶åˆ°æ¶ˆæ¯

### ç¾¤èŠæµç¨‹

1. **å®¢æˆ·ç«¯å‘é€**ï¼šç”¨æˆ·é€šè¿‡ WebSocket å‘é€ç¾¤èŠæ¶ˆæ¯
2. **æœåŠ¡å™¨å¤„ç†**ï¼š
   - éªŒè¯ Tokenï¼Œè·å–å‘é€è€…ID
   - è°ƒç”¨ `GroupChat` ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
   - è®¾ç½®ä¼šè¯IDä¸ºç¾¤IDï¼ˆå¦‚æœæœªæä¾›ï¼Œä½¿ç”¨ "all"ï¼‰
   - å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆæˆ–ç¾¤æˆå‘˜ï¼‰
3. **æ¥æ”¶è€…æ¥æ”¶**ï¼šæ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ˆæˆ–ç¾¤æˆå‘˜ï¼‰çš„ WebSocket è¿æ¥æ”¶åˆ°æ¶ˆæ¯

## ğŸš€ å¯åŠ¨æœåŠ¡

### åŒæ—¶å¯åŠ¨ HTTP å’Œ WebSocket

```bash
cd BackEnd
go run cmd/api/main.go -f etc/backend.yaml
```

æœåŠ¡å¯åŠ¨åä¼šï¼š
- **HTTP API æœåŠ¡**ï¼šè¿è¡Œåœ¨ `http://127.0.0.1:8889`
- **WebSocket æœåŠ¡**ï¼šè¿è¡Œåœ¨ `ws://127.0.0.1:9000/ws`

### æœåŠ¡æ—¥å¿—

```
Starting HTTP API server at 127.0.0.1:8889...
Swagger UI: http://127.0.0.1:8889/swagger/index.html
å¯åŠ¨ WebSocket æœåŠ¡: 127.0.0.1:9000
```

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **JWT è®¤è¯**ï¼šæ‰€æœ‰ WebSocket è¿æ¥å¿…é¡»æä¾›æœ‰æ•ˆçš„ JWT Token
2. **ç”¨æˆ·IDéªŒè¯**ï¼šå‘é€è€…IDä» Token ä¸­æå–ï¼Œé˜²æ­¢ä¼ªé€ 
3. **å•ç‚¹ç™»å½•**ï¼šåŒä¸€ç”¨æˆ·çš„æ–°è¿æ¥ä¼šå…³é—­æ—§è¿æ¥
4. **è¿æ¥ç®¡ç†**ï¼šä½¿ç”¨è¯»å†™é”ä¿æŠ¤è¿æ¥æ˜ å°„ï¼Œç¡®ä¿å¹¶å‘å®‰å…¨

## ğŸ“Š è¿æ¥ç®¡ç†

### è¿æ¥æ˜ å°„

```go
uidToConn map[string]*websocket.Conn  // ç”¨æˆ·ID -> WebSocketè¿æ¥
connToUid map[*websocket.Conn]string  // WebSocketè¿æ¥ -> ç”¨æˆ·ID
```

### è¿æ¥ç”Ÿå‘½å‘¨æœŸ

1. **å»ºç«‹è¿æ¥**ï¼šç”¨æˆ·é€šè¿‡ WebSocket è¿æ¥ï¼ŒéªŒè¯ Token åæ·»åŠ åˆ°æ˜ å°„
2. **æ¶ˆæ¯å¤„ç†**ï¼šåœ¨ç‹¬ç«‹çš„ goroutine ä¸­å¤„ç†æ¶ˆæ¯æ”¶å‘
3. **æ–­å¼€è¿æ¥**ï¼šè¿æ¥å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†æ˜ å°„å…³ç³»

## ğŸ§ª æµ‹è¯•

### ä½¿ç”¨ wscat æµ‹è¯•

```bash
# å®‰è£… wscat
npm install -g wscat

# è¿æ¥ WebSocketï¼ˆéœ€è¦å…ˆè·å– Tokenï¼‰
wscat -c "ws://127.0.0.1:9000/ws?token=<your_token>"

# å‘é€ç§èŠæ¶ˆæ¯
{"recvId": "2", "chatType": 2, "content": "ä½ å¥½", "contentType": 1}

# å‘é€ç¾¤èŠæ¶ˆæ¯
{"chatType": 1, "content": "å¤§å®¶å¥½", "contentType": 1}
```

### å‰ç«¯æµ‹è¯•

å‰ç«¯ä»£ç ä¼šè‡ªåŠ¨è¿æ¥ WebSocketï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚ç¡®ä¿ï¼š

1. å‰ç«¯ç¯å¢ƒå˜é‡ `VITE_WS_BASE_URL` è®¾ç½®ä¸º `ws://127.0.0.1:9000`
2. ç”¨æˆ·å·²ç™»å½•å¹¶è·å– Token
3. WebSocket æœåŠ¡æ­£åœ¨è¿è¡Œ

## ğŸ”„ ä¸ AIWorkHelper çš„å·®å¼‚

| ç‰¹æ€§ | AIWorkHelper | BackEnd |
|------|-------------|---------|
| **æ•°æ®åº“** | MongoDB | MySQL + GORM |
| **ç”¨æˆ·IDç±»å‹** | string | uint |
| **ç¾¤èŠæˆå‘˜ç®¡ç†** | æŸ¥è¯¢ GroupMember è¡¨ | å½“å‰å¹¿æ’­ç»™æ‰€æœ‰ç”¨æˆ·ï¼ˆTODOï¼šå®ç°ç¾¤æˆå‘˜ç®¡ç†ï¼‰ |
| **æ—¥å¿—åº“** | tlog | zerolog |
| **Tokenè§£æ** | token.Parse | jwt.ParseToken |

## ğŸ“ TODO

- [ ] å®ç°ç¾¤æˆå‘˜ç®¡ç†ï¼ˆæ ¹æ®ç¾¤IDæŸ¥è¯¢æˆå‘˜ï¼Œåªå‘é€ç»™ç¾¤æˆå‘˜ï¼‰
- [ ] æ·»åŠ å¿ƒè·³æ£€æµ‹ï¼Œè‡ªåŠ¨æ¸…ç†æ–­å¼€çš„è¿æ¥
- [ ] å®ç°æ¶ˆæ¯å·²è¯»çŠ¶æ€
- [ ] æ·»åŠ è¿æ¥æ•°é™åˆ¶å’Œæµé‡æ§åˆ¶
- [ ] ç”Ÿäº§ç¯å¢ƒé™åˆ¶ WebSocket æ¥æºï¼ˆCheckOriginï¼‰

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯è¿æ¥

```typescript
import { createWebSocket } from '@/utils/websocket'

const token = userStore.userInfo?.token
const wsClient = createWebSocket(token)
await wsClient.connect()

// å‘é€ç§èŠæ¶ˆæ¯
wsClient.send({
  recvId: '123',
  chatType: 2,
  content: 'ä½ å¥½',
  contentType: 1
})

// å‘é€ç¾¤èŠæ¶ˆæ¯
wsClient.send({
  conversationId: 'group_001',
  chatType: 1,
  content: 'å¤§å®¶å¥½',
  contentType: 1
})
```

## âœ… å®ŒæˆçŠ¶æ€

- âœ… WebSocket æœåŠ¡å™¨å®ç°
- âœ… è¿æ¥ç®¡ç†ï¼ˆæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾ï¼‰
- âœ… èº«ä»½éªŒè¯ï¼ˆJWT Tokenï¼‰
- âœ… ç§èŠæ¶ˆæ¯å¤„ç†
- âœ… ç¾¤èŠæ¶ˆæ¯å¤„ç†ï¼ˆå¹¿æ’­æ¨¡å¼ï¼‰
- âœ… æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“
- âœ… å¹¶å‘å®‰å…¨ï¼ˆè¯»å†™é”ï¼‰
- âœ… é…ç½®ç®¡ç†
- âœ… ä¸»ç¨‹åºé›†æˆ

WebSocket åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼

